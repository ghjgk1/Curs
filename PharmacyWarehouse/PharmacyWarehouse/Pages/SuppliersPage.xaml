<Page x:Class="PharmacyWarehouse.Pages.SuppliersPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:PharmacyWarehouse.Pages"
      mc:Ignorable="d" 
      Title="Поставщики">

        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <StackPanel Margin="16">

                <!-- ЗАГОЛОВОК И КНОПКИ -->
                <Border Style="{StaticResource Card}">
                    <StackPanel>
                        <TextBlock Text="Управление поставщиками" Style="{StaticResource H1}"/>

                        <StackPanel Style="{StaticResource ToolbarPanel}">
                            <Button Content="Добавить поставщика" Style="{StaticResource PrimaryButton}" Width="160" Click="AddSupplier_Click"/>
                            <Button Content="Редактировать" Style="{StaticResource SecondaryButton}" Width="120" Margin="8,0,0,0" Click="EditSupplier_Click"/>
                            <Button Content="Удалить" Style="{StaticResource WarningButton}" Width="100" Margin="8,0,0,0" Click="DeleteSupplier_Click"/>
                            <Button Content="Импорт" Style="{StaticResource OutlineButton}" Width="100" Margin="8,0,0,0"/>
                            <Button Content="Экспорт" Style="{StaticResource OutlineButton}" Width="100" Margin="8,0,0,0"/>

                            <Separator Margin="24,0"/>

                            <Button Content="📞" Style="{StaticResource IconButton}" ToolTip="Контактная книга"/>
                            <Button Content="📊" Style="{StaticResource IconButton}" ToolTip="Отчет по поставкам"/>
                            <Button Content="📋" Style="{StaticResource IconButton}" ToolTip="Шаблоны договоров"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- ФИЛЬТРЫ И ПОИСК -->
                <Border Style="{StaticResource FilterPanel}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Фильтры поставщиков" Style="{StaticResource H3}" Margin="0,0,0,12"/>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- Поиск -->
                            <StackPanel Margin="0,0,12,0">
                                <TextBlock Text="Поиск" Style="{StaticResource BodyText}" Margin="0,0,0,4"/>
                                <TextBox x:Name="SearchTextBox"
                                         Text="{Binding SearchSupplier.Name, UpdateSourceTrigger=PropertyChanged}"
                                         KeyDown="SearchTextBox_KeyDown"/>
                            </StackPanel>


                            <!-- Статус -->
                            <StackPanel Grid.Column="1">
                                <TextBlock Text="Статус" Style="{StaticResource BodyText}" Margin="0,0,0,4"/>
                                <ComboBox x:Name="cmbStatus" SelectionChanged="CmbStatus_SelectionChanged">
                                    <ComboBoxItem Content="Все" IsSelected="True"/>
                                    <ComboBoxItem Content="Активные"/>
                                    <ComboBoxItem Content="Неактивные"/>
                                    <ComboBoxItem Content="С партиями"/>
                                    <ComboBoxItem Content="Без партий"/>
                                </ComboBox>
                            </StackPanel>
                                
                            <!-- Кнопки фильтров -->
                                <StackPanel Grid.Column="2" VerticalAlignment="Bottom">
                                    <Button Content="Применить" Style="{StaticResource PrimaryButton}" Width="100" Click="ApplyFilters_Click"/>
                                <Button Content="Сбросить" Style="{StaticResource OutlineButton}" Width="100" Margin="0,8,0,0"  Click="ResetFilters_Click"/>
                                </StackPanel>
                            </Grid>
                        </StackPanel>

                        <!-- Статистика -->
                        <Border Grid.Column="1" 
                           Margin="24,0,0,0"
                           Padding="16"
                           Background="{StaticResource BackgroundLightBrush}"
                           BorderBrush="{StaticResource BorderLightBrush}"
                           BorderThickness="1"
                           CornerRadius="4">
                            <StackPanel>
                                <TextBlock Text="Статистика" Style="{StaticResource H3}" Margin="0,0,0,8"/>
                                <TextBlock x:Name="txtActiveCount1" Text="Всего: 0" Style="{StaticResource BodyText}"/>
                                <TextBlock x:Name="txtActiveSuppliers" Text="Активных: 0" Style="{StaticResource BodyText}"/>
                            <TextBlock x:Name="txtWithBatches" Text="Поставок за месяц: 0" Style="{StaticResource BodyText}"/>
                            <TextBlock x:Name="txtWithDocuments" Text="Среднее время: 0 дн." Style="{StaticResource BodyText}"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </Border>

                <!-- ТАБЛИЦА ПОСТАВЩИКОВ -->
                <Border Style="{StaticResource Card}" Padding="0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Заголовок таблицы -->
                        <Border Grid.Row="0" Style="{StaticResource CardHeader}">
                            <TextBlock Text="Список поставщиков" Style="{StaticResource H3}" Foreground="{StaticResource TextWhiteBrush}"/>
                        </Border>

                        <!-- Таблица -->
                        <DataGrid x:Name="dgSuppliers" 
                                  Grid.Row="1"
                                  MouseDoubleClick="DgSuppliers_MouseDoubleClick"
                                  SelectionChanged="DgSuppliers_SelectionChanged"
                                  CanUserAddRows="False"
                                  AutoGenerateColumns="False">

                            <DataGrid.Columns>
                                <!-- Название -->
                                <DataGridTextColumn Header="Название" 
                                               Width="200"
                                               Binding="{Binding Name}">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                            <Setter Property="ToolTip" Value="{Binding Name}"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <!-- Контактное лицо -->
                                <DataGridTextColumn Header="Контактное лицо" 
                                               Width="170"
                                               Binding="{Binding ContactPerson}"/>

                                <!-- Телефон -->
                                <DataGridTextColumn Header="Телефон" 
                                               Width="150"
                                               Binding="{Binding Phone}"/>

                                <!-- Email -->
                            <!-- ИНН -->
                                <DataGridTextColumn Header="ИНН" 
                                                   Width="120"
                                                   Binding="{Binding TaxId}">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock" BasedOn="{StaticResource DataGridCellCenter}"/>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <!-- Всего поставок -->
                                <DataGridTextColumn Header="Поставок" 
                                                   Width="120"
                                                   Binding="{Binding TotalDeliveries}">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock" BasedOn="{StaticResource DataGridCellCenter}"/>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <!-- Последняя поставка -->
                                <DataGridTextColumn Header="Последняя поставка" 
                                                   Width="150"
                                                   Binding="{Binding LastDeliveryDate, StringFormat='dd.MM.yyyy'}">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock" BasedOn="{StaticResource DataGridCellCenter}"/>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                            <!-- Статус -->
                                <DataGridTemplateColumn Header="Статус" Width="100">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border CornerRadius="12" 
                                               Padding="6,2"
                                               HorizontalAlignment="Center">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Setter Property="Background" Value="{StaticResource AccentGreenBrush}"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsActive}" Value="False">
                                                                <Setter Property="Background" Value="{StaticResource GrayBrush}"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding HasLateDeliveries}" Value="True">
                                                                <Setter Property="Background" Value="{StaticResource AccentOrangeBrush}"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <TextBlock Text="{Binding StatusText}"
                                                      Foreground="White"
                                                      FontWeight="SemiBold"
                                                      FontSize="11"
                                                      HorizontalAlignment="Center"/>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                            </DataGrid.Columns>

                            <DataGrid.RowStyle>
                                <Style TargetType="DataGridRow">
                                    <Style.Triggers>
                                        <!-- Выделение неактивных поставщиков -->
                                        <DataTrigger Binding="{Binding IsActive}" Value="False">
                                            <Setter Property="Foreground" Value="{StaticResource GrayBrush}"/>
                                            <Setter Property="FontStyle" Value="Italic"/>
                                        </DataTrigger>
                                        <!-- Выделение поставщиков с просрочками -->
                                        <DataTrigger Binding="{Binding HasLateDeliveries}" Value="True">
                                            <Setter Property="Background" Value="{StaticResource ProductExpiringBrush}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGrid.RowStyle>
                        </DataGrid>

                        <!-- Информация -->
                        <Border Grid.Row="2" 
                           Background="{StaticResource BackgroundLightBrush}"
                           BorderBrush="{StaticResource BorderLightBrush}"
                           BorderThickness="0,1,0,0"
                           Padding="12">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Всего поставщиков: " Style="{StaticResource BodyText}"/>
                                <TextBlock x:Name="txtTotalSuppliers" Text="0" 
                                      FontWeight="SemiBold" 
                                      Margin="0,0,24,0"/>

                                <TextBlock Text="Активных: " Style="{StaticResource BodyText}"/>
                                <TextBlock x:Name="txtActiveCount" Text="0" 
                                      FontWeight="SemiBold"
                                      Foreground="{StaticResource AccentGreenBrush}"
                                      Margin="0,0,24,0"/>

                                <TextBlock Text="Неактивных: " Style="{StaticResource BodyText}"/>
                                <TextBlock x:Name="txtInactiveCount" Text="0" 
                                      FontWeight="SemiBold"
                                      Foreground="{StaticResource GrayBrush}"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </Border>

                <!-- БЫСТРЫЙ ПРОСМОТР -->
                <Border Style="{StaticResource Card}" Padding="12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Контактная информация -->
                        <StackPanel Grid.Column="0" Margin="0,0,12,0">
                            <TextBlock Text="Контактная информация" Style="{StaticResource H3}" Margin="0,0,0,12"/>

                            <Border Style="{StaticResource InfoBox}">
                                <StackPanel>
                                    <TextBlock x:Name="txtSelectedSupplier" Text="Не выбран поставщик" 
                                          FontWeight="SemiBold"
                                          Margin="0,0,0,8"/>
                                    <TextBlock x:Name="txtSupplierPhone" Text="Телефон: -" Style="{StaticResource BodyText}"/>
                                    <TextBlock x:Name="txtSupplierAddress" Text="Адрес: -" Style="{StaticResource BodyText}"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- Последние поставки -->
                        <StackPanel Grid.Column="1">
                            <TextBlock Text="Последние поставки" Style="{StaticResource H3}" Margin="0,0,0,12"/>

                            <DataGrid x:Name="dgRecentDeliveries" 
                                 Height="150"
                                 AutoGenerateColumns="False"
                                 IsReadOnly="True">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Дата" Width="100" Binding="{Binding Date, StringFormat='dd.MM.yyyy'}"/>
                                    <DataGridTextColumn Header="Номер" Width="120" Binding="{Binding DocumentNumber}"/>
                                    <DataGridTextColumn Header="Сумма" Width="100" Binding="{Binding Amount, StringFormat='N2'}"/>
                                    <DataGridTextColumn Header="Статус" Width="80">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="HorizontalAlignment" Value="Center"/>
                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Status}" Value="Оплачено">
                                                        <Setter Property="Foreground" Value="{StaticResource AccentGreenBrush}"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Status}" Value="Ожидает">
                                                        <Setter Property="Foreground" Value="{StaticResource AccentOrangeBrush}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </StackPanel>
                    </Grid>
                </Border>

            </StackPanel>
        </ScrollViewer>
</Page>
